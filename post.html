<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEE JONGHEON</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./pages.css">
</head>
<body>
    <nav class="nav">
        <div class="navMain">
            <a href="./index.html">HOME</a>
            <a href="./works.html">WORK</a>
            <a href="./contact.html">CONTACT</a>
        </div>
    </nav>
    <header>
        <div class="header-container">
            <a href="./index.html" class="header-l">
                <span>HEON</span>
            </a>
            <input type="checkbox" name="" id="navCheckbox" class="dpnone">
            <div class="header-r">
                <label for="navCheckbox" id="navToggle">
                    +
                </label>    
            </div>
        </div>
    </header>
    <main>
        <div class="worksNavBar">
            <a href="./works.html">Works</a>
            <span>></span>
            <span id="breadcrumbTitle"></span>
        </div>
        
        <!-- 타이틀 섹션 -->
        <section class="sc-first sc">
            <h1 id="postTitle" style="font-size: 2rem; margin-bottom: 20px; color: var(--txtColor-1);"></h1>
            <p id="postCategory" style="color: var(--txtColor-3); margin-bottom: 10px;"></p>
        </section>

        <!-- 이미지 슬라이더 섹션 -->
        <section class="sc-slider sc">
            <div class="img-container" id="imgContainer">
                <!-- 슬라이더 이미지 동적 삽입 -->
            </div>
            <div class="ctrl-container">
                <div class="btn-move btn-move-prev">&#10094;</div>
                <div class="btn-move btn-move-c"></div>
                <div class="btn-move btn-move-next">&#10095;</div>
            </div>
        </section>
        
        <!-- 슬라이더 도트 -->
        <section class="slideDots"></section>

        <!-- 컨텐츠 섹션 -->
        <section class="sc-content sc" style="margin: 40px auto; max-width: 1000px;">
            <div id="postContent" style="color: var(--txtColor-2); line-height: 1.8;">
                <!-- 컨텐츠 동적 삽입 -->
            </div>
        </section>

        <!-- 모든 이미지 섹션 (클릭 가능) -->
        <section class="sc-images sc">
            <!-- 모든 이미지 동적 삽입 -->
        </section>
    </main>

    <!-- 로딩 스피너 -->
    <div id="loadingSpinner" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #0e0e0e;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    ">
        <div style="
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        "></div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        // ========== 설정 ==========
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxPncRFevyI6TrJsXDg15izhSs8SmJd8BCzgAKAtm5HgyIwfrGtSYOIcwZabogha5gYzA/exec';

        // URL에서 게시물 ID 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');

        if (!postId) {
            alert('Invalid post ID');
            window.location.href = './works.html';
        }

        let slideDB = []; // 슬라이더용 이미지 배열

        // ========== 게시물 데이터 로드 ==========
        async function loadPost() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'getPost',
                        id: postId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayPost(result.post);
                } else {
                    throw new Error(result.message || 'Failed to load post');
                }
            } catch (error) {
                console.error('Load error:', error);
                alert('Failed to load post. Redirecting to works page...');
                window.location.href = './works.html';
            } finally {
                // 로딩 스피너 제거
                const spinner = document.getElementById('loadingSpinner');
                if (spinner) spinner.remove();
            }
        }

        // ========== 구글 드라이브 URL을 썸네일 URL로 변환 ==========
        function convertToThumbnailUrl(url) {
            if (!url) return '';
            
            // Google Drive URL에서 파일 ID 추출
            const patterns = [
                /[?&]id=([a-zA-Z0-9_-]+)/,     // id=FILE_ID 형식 (먼저 체크)
                /\/d\/([a-zA-Z0-9_-]+)/,        // /d/FILE_ID 형식
                /\/file\/d\/([a-zA-Z0-9_-]+)/   // /file/d/FILE_ID 형식
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    const fileId = match[1];
                    // 썸네일 API 사용 (더 안정적)
                    return `https://drive.google.com/thumbnail?id=${fileId}&sz=w2000`;
                }
            }
            
            // 패턴 매칭 실패 시 원본 URL 반환
            return url;
        }

        // ========== 게시물 표시 ==========
        function displayPost(post) {
            // 타이틀 설정
            document.getElementById('postTitle').textContent = post.title;
            document.getElementById('breadcrumbTitle').textContent = post.title;
            document.getElementById('postCategory').textContent = post.category || 'Uncategorized';
            document.title = `${post.title} - LEE JONGHEON`;

            // 컨텐츠에서 이미지와 비디오 추출
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = post.content;
            
            const images = tempDiv.querySelectorAll('img');
            const videos = tempDiv.querySelectorAll('video');

            // 슬라이더용 이미지 배열 생성 (썸네일 URL로 변환)
            slideDB = Array.from(images).map((img, index) => ({
                num: (index + 1).toString(),
                img: convertToThumbnailUrl(img.src)
            }));

            // 이미지가 있으면 슬라이더 초기화
            if (slideDB.length > 0) {
                initializeSlider();
            } else {
                // 이미지가 없으면 슬라이더 섹션 숨김
                document.querySelector('.sc-slider').style.display = 'none';
                document.querySelector('.slideDots').style.display = 'none';
            }

            // 비디오 처리 - 구글 드라이브 URL을 iframe으로 변경
            videos.forEach(video => {
                const videoSrc = video.src;
                // 구글 드라이브 URL에서 파일 ID 추출
                let fileId = null;
                
                if (videoSrc.includes('drive.google.com/uc?')) {
                    const match = videoSrc.match(/id=([^&]+)/);
                    if (match) fileId = match[1];
                } else if (videoSrc.includes('drive.google.com/file/d/')) {
                    const match = videoSrc.match(/\/d\/([^/]+)/);
                    if (match) fileId = match[1];
                }
                
                if (fileId) {
                    const iframe = document.createElement('iframe');
                    iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
                    iframe.width = '100%';
                    iframe.style.aspectRatio = '16/9';
                    iframe.style.maxWidth = '800px';
                    iframe.style.margin = '20px auto';
                    iframe.style.display = 'block';
                    iframe.frameBorder = '0';
                    iframe.allow = 'autoplay';
                    video.replaceWith(iframe);
                }
            });

            // 컨텐츠 표시 (이미지는 제거하고 텍스트와 비디오만)
            images.forEach(img => img.remove());
            document.getElementById('postContent').innerHTML = tempDiv.innerHTML;

            // sc-images 섹션에 모든 이미지 표시
            const scImages = document.querySelector('.sc-images');
            const imagesHTML = slideDB.map(item => `<img src="${item.img}" onerror="this.style.display='none'">`).join('');
            scImages.innerHTML = imagesHTML;

            // 이미지 클릭 시 새 창에서 열기
            addImageClickEvent();
        }

        // ========== 슬라이더 초기화 ==========
        function initializeSlider() {
            const imgContainer = document.getElementById('imgContainer');
            const slideDots = document.querySelector('.slideDots');

            // 슬라이더 이미지 생성
            const slideImgHTML = slideDB.map(item => `<img src="${item.img}" onerror="this.style.display='none'" loading="lazy">`).join('');
            imgContainer.innerHTML = slideImgHTML;

            // 도트 생성
            const dotsHTML = slideDB.map(item => `<div class="dot" data-num="${item.num}"></div>`).join('');
            slideDots.innerHTML = dotsHTML;

            // 슬라이더 제어
            let slideStatu = 1;
            const totalSlides = slideDB.length;

            function updateDots() {
                const dots = document.querySelectorAll('.dot');
                dots.forEach(dot => dot.classList.remove('active'));
                if (dots[slideStatu - 1]) {
                    dots[slideStatu - 1].classList.add('active');
                }
            }

            function moveSlide(direction) {
                if (direction === 'next') {
                    slideStatu = slideStatu < totalSlides ? slideStatu + 1 : 1;
                } else if (direction === 'prev') {
                    slideStatu = slideStatu > 1 ? slideStatu - 1 : totalSlides;
                }
                imgContainer.style.transform = `translateX(calc(-100% * ${slideStatu - 1}))`;
                updateDots();
            }

            function jumpToSlide(num) {
                slideStatu = parseInt(num);
                imgContainer.style.transform = `translateX(calc(-100% * ${slideStatu - 1}))`;
                updateDots();
            }

            const prev = document.querySelector('.btn-move-prev');
            const next = document.querySelector('.btn-move-next');
            prev.addEventListener('click', () => moveSlide('prev'));
            next.addEventListener('click', () => moveSlide('next'));

            slideDots.addEventListener('click', (e) => {
                if (e.target.classList.contains('dot')) {
                    jumpToSlide(e.target.getAttribute('data-num'));
                }
            });

            updateDots();
        }

        // ========== 이미지 클릭 이벤트 ==========
        function addImageClickEvent() {
            const images = document.querySelectorAll('.sc-images img');
            images.forEach(image => {
                image.addEventListener('click', () => {
                    window.open(image.src, '_blank');
                });
            });
        }

        // ========== 초기 로드 ==========
        loadPost();
    </script>

    <script src="./navToggle.js"></script>
    <script src="./auth.js"></script>
</body>
</html>
